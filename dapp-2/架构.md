# Geth 架构设计

## 分层架构

```
┌─────────────────────────────────────────┐
│         P2P网络层                        │
│  (节点发现、消息传输、协议管理)             │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│        区块链协议层                       │
│  (区块同步、交易处理、共识机制)             │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│        状态存储层                         │
│  (MPT树、状态管理、数据持久化)              │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│        EVM执行层                         │
│  (虚拟机、指令执行、Gas计算)               │
└─────────────────────────────────────────┘
```

---

## 各层关键模块说明

### 1. P2P 网络层

#### 1.1 les（轻节点协议）

- **设计目标**：允许资源受限设备运行轻节点，只下载必要数据
- **轻节点与全节点交互**：
  - 轻节点通过 LES 协议向全节点请求区块头、状态证明
  - 全节点提供 Merkle 证明，验证数据完整性
  - 支持按需获取，减少带宽消耗
- **信任模型**：基于 Merkle 证明，无需信任全节点
- **安全性**：通过密码学证明确保数据正确性
- **源码位置**：`les/` 目录

#### 1.2 p2p/discover（节点发现）

- **Kademlia 协议**：实现 DHT 节点发现
- **路由表管理**：维护 k-bucket，存储邻居节点
- **节点查询**：FindNode 查找指定节点
- **源码位置**：`p2p/discover/` 目录

#### 1.3 p2p（P2P 网络核心）

- **连接管理**：建立和维护节点连接
- **消息传输**：RLPx 协议加密通信
- **协议协商**：支持多协议（eth、les 等）
- **源码位置**：`p2p/` 目录

---

### 2. 区块链协议层

#### 2.1 core/types（区块数据结构）

- **Block 结构**：包含 Header、Transactions、Uncles
- **Header 结构**：区块头，包含父哈希、状态根、交易根等
- **Transaction 结构**：交易数据，包含发送者、接收者、Gas 等
- **Receipt 结构**：交易收据，记录执行结果和日志
- **Log 结构**：事件日志，用于合约事件查询
- **序列化**：使用 RLP 编码，支持网络传输和持久化
- **源码位置**：`core/types/` 目录

#### 2.2 eth（以太坊协议实现）

- **协议处理**：实现 eth/62、eth/63 协议
- **区块同步**：处理区块下载和验证
- **交易广播**：传播交易到网络
- **源码位置**：`eth/` 目录

#### 2.3 consensus（共识引擎）

- **接口设计**：Engine 接口，支持多种共识算法
- **Ethash 实现**：PoW 共识算法
- **区块验证**：验证区块头、交易、状态
- **源码位置**：`consensus/` 目录

#### 2.4 core/txpool（交易池）

- **交易管理**：pending 和 queue 队列
- **Gas 排序**：按 Gas 价格排序交易
- **Nonce 管理**：处理交易 Nonce 顺序
- **源码位置**：`core/txpool/` 目录

---

### 3. 状态存储层

#### 3.1 trie（默克尔树实现）

- **MPT 结构**：Merkle Patricia Tree 实现
- **节点类型**：Extension、Branch、Leaf 节点
- **路径压缩**：优化存储空间
- **Merkle 证明**：生成和验证状态证明
- **源码位置**：`trie/` 目录

#### 3.2 core/state（状态管理）

- **StateDB 接口**：状态数据库抽象
- **账户管理**：账户余额、Nonce、代码、存储
- **状态转换**：执行交易后的状态更新
- **快照机制**：支持状态快照和回滚
- **源码位置**：`core/state/` 目录

#### 3.3 core/rawdb（原始数据库）

- **LevelDB 接口**：底层数据库操作
- **数据编码**：RLP 编码存储
- **索引管理**：区块、交易、收据索引
- **源码位置**：`core/rawdb/` 目录

---

### 4. EVM 执行层

#### 4.1 core/vm（EVM 虚拟机）

- **指令集**：实现 EVM 所有操作码
- **执行引擎**：解释执行字节码
- **栈管理**：维护执行栈（1024 深度）
- **内存管理**：临时内存分配和释放
- **Gas 计算**：实时计算和消耗 Gas
- **源码位置**：`core/vm/` 目录

#### 4.2 core/vm/instructions（指令实现）

- **算术指令**：ADD、SUB、MUL 等
- **逻辑指令**：AND、OR、XOR 等
- **存储指令**：SLOAD、SSTORE 等
- **调用指令**：CALL、DELEGATECALL 等
- **源码位置**：`core/vm/instructions.go`

#### 4.3 core/vm/stack（栈操作）

- **栈结构**：LIFO 栈实现
- **栈操作**：Push、Pop、Peek 等
- **溢出检测**：防止栈溢出攻击
- **源码位置**：`core/vm/stack.go`

---

## 模块交互流程

### 交易处理流程

```
P2P网络层接收交易
    ↓
区块链协议层验证交易
    ↓
交易池管理（TxPool）
    ↓
EVM执行层执行交易
    ↓
状态存储层更新状态
    ↓
MPT树计算新根哈希
    ↓
区块打包和共识
```

### 区块同步流程

```
P2P网络层发现节点
    ↓
区块链协议层请求区块
    ↓
状态存储层验证状态
    ↓
EVM执行层验证交易
    ↓
共识层验证区块头
    ↓
存储到本地数据库
```
